#!/usr/bin/perl

#
# Ant wrapper for builds
#

use strict;

my %local = ();

&load_properties("build.properties");

my $ant_cmd = "ant";
if (exists $local{'rel.architecture'} && $local{'rel.architecture'} eq "windows") {
  $ant_cmd = "ant.bat";
}

&check_local();

$ENV{'ANT_OPTS'} = "-Xms128m -Xmx512m -XX:MaxPermSize=128m";

my $retval = system("$ENV{ANT_HOME}/bin/${ant_cmd}", @ARGV);

exit($retval);

#
# load a property file
#
sub load_properties {

  my ($prop_file) = @_;

  if (open BUILDPROP, "./${prop_file}") {
    while (<BUILDPROP>) {
        next if /^#/;
        if (/\s*(\S+)\s*=\s*(\S+)\s*/) {
          $local{$1} = $2;
        }
    }
    close BUILDPROP;
  }
  else {
    print "WARNING: could not open ${prop_file}!\n";
  }

}

#
# check all local paths
#
sub check_local {

  foreach my $key (keys(%local)) {
    if ($key =~ /^[A-Z_]+$/) {
      print "$key=$local{$key}\n";
      if ($key =~ /_HOME$/ && ! -d $local{$key} ) {
        die "\nERROR: invalid or unspecified $key!\n";
      }
      $ENV{$key} = $local{$key};
    }
  }

}
